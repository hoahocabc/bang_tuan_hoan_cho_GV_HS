<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Bảng tuần hoàn NTHH (hoahocABC)</title>

    <!-- p5.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
      :root{
        --bg: #f4fbff;
        --card: #ffffff;
        --muted: #475569;
        --accent: #0ea5e9;
        --accent-600: #0369a1;
        --shadow: 0 10px 30px rgba(12,18,30,0.08);

        /* toolbar sizing variable (controlled by JS) */
        --toolbar-font-size: 16px;
        --label-padding-vertical: 6px;
        --label-padding-horizontal: 10px;
        --toolbar-gap: 10px;
      }

      * { box-sizing: border-box; }
      html,body { height:100%; margin:0; }
      body{
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        background: linear-gradient(180deg,#f7fbff 0%, var(--bg) 60%);
        color:#071022;
        -webkit-font-smoothing:antialiased;
      }

      /* Canvas */
      #defaultCanvas0{
        display:block;
        margin: 12px auto 28px auto;
        border-radius: 12px;
        box-shadow: var(--shadow);
        background: transparent;
        max-width: calc(100% - 24px);
      }

      /* Toolbar */
      .toolbar {
        position: fixed;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1400;
        display:flex;
        gap:var(--toolbar-gap);
        align-items:center;
        padding:8px 10px;
        border-radius: 12px;
        background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,252,255,0.98));
        box-shadow: var(--shadow);
        flex-wrap: nowrap;
        max-width: calc(100% - 32px);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        white-space: nowrap;
        font-size: var(--toolbar-font-size);
      }
      .toolbar.wrapable { flex-wrap: wrap; white-space: normal; }
      .toolbar::-webkit-scrollbar{ height:6px; display:none; }

      .toolbar .group{ display:flex; gap:8px; align-items:center; }

      .toolbar label{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:var(--label-padding-vertical) var(--label-padding-horizontal);
        border-radius: 10px;
        background: rgba(255,255,255,0.6);
        border: 1px solid rgba(10,14,20,0.04);
        cursor: pointer;
        color: var(--muted);
        font-weight:600;
        font-size: var(--toolbar-font-size);
        white-space:nowrap;
        flex: 0 0 auto;
      }
      .toolbar.wrapable label { white-space: normal; max-width: 160px; flex: 1 1 auto; }

      .toolbar label:hover { transform: translateY(-2px); background: rgba(255,255,255,0.85); }
      .toolbar input[type="checkbox"]{ width:1.125em; height:1.125em; accent-color: var(--accent); }

      .guide-btn{
        margin-left: 6px;
        padding: 7px 12px;
        border-radius: 9px;
        background: linear-gradient(180deg,#fff,#f8fbff);
        border:1px solid rgba(8,12,20,0.06);
        color:var(--accent-600);
        font-weight:700;
        cursor:pointer;
        white-space:nowrap;
        font-size: calc(var(--toolbar-font-size) * 0.95);
      }

      .lang-select { margin-left: 6px; display:flex; align-items:center; gap:8px; }
      .lang-select select {
        padding:6px 10px;
        border-radius:8px;
        border:1px solid rgba(8,12,20,0.06);
        background:var(--card);
        font-weight:600;
        color:#071022;
        font-size: calc(var(--toolbar-font-size) * 0.95);
      }

      /* Popups */
      #element-popup, #note-popup{
        position: fixed;
        z-index: 1500;
        display:none;
        min-width:220px;
        max-width:520px;
        background: linear-gradient(180deg,#fff,#fbfdff);
        border-radius: 12px;
        box-shadow: 0 16px 48px rgba(12,18,30,0.12);
        padding:14px;
        font-size:1rem;
      }
      #element-popup .popup-title{ font-weight:700; font-size:1.15rem; text-align:center; margin-bottom:8px; }
      #element-popup .meta{ color:var(--muted); margin:6px 0; white-space:normal; }

      #note-popup { max-height: 70vh; overflow-y: auto; }
      #note-popup .note-title { text-align:center; font-weight:700; color:var(--accent-600); margin-bottom:8px; }
      #note-popup .note-close { position:absolute; right:8px; top:8px; border:none; background:none; font-size:18px; cursor:pointer; color:#9aa3b2; }

      @media (max-width:700px){
        .toolbar { left: 8px; transform: none; right: 8px; top: 8px; }
        .lang-select select { font-size:calc(var(--toolbar-font-size) * 0.9); padding:5px 8px; }
        #element-popup, #note-popup { left:8px !important; right:8px !important; max-width:none; width: calc(100% - 16px); }
      }

      @media (max-width:600px){
        :root {
          --label-padding-vertical: 7px;
          --label-padding-horizontal: 8px;
          --toolbar-gap: 8px;
        }
        .toolbar { padding: 10px; gap:8px; }
        .toolbar label { font-weight:700; font-size: calc(var(--toolbar-font-size) * 0.95); min-height: 40px; }
        .toolbar input[type="checkbox"]{ width:1.5em; height:1.5em; }
        .guide-btn{ padding: 10px 14px; font-size:calc(var(--toolbar-font-size) * 0.95); }
        #defaultCanvas0 { margin: 8px auto 20px auto; border-radius:10px; }
      }

      input:focus, select:focus, button:focus, label:focus { outline: 3px solid rgba(14,165,233,0.12); outline-offset:2px; border-radius:8px; }
    </style>
  </head>

  <body>
    <div class="toolbar" id="toolbar" role="toolbar" aria-label="Controls">
      <div class="group" aria-label="Filters">
        <label title="Kim loại"><input type="checkbox" id="showMetal"/><span id="label_showMetal">Kim loại</span></label>
        <label title="Phi kim"><input type="checkbox" id="showNonMetal"/><span id="label_showNonMetal">Phi kim</span></label>
        <label title="Khí trơ (Khí hiếm)"><input type="checkbox" id="showNobleGas"/><span id="label_showNobleGas">Khí trơ (khí hiếm)</span></label>
        <label title="Á kim"><input type="checkbox" id="showMetalloid"/><span id="label_showMetalloid">Á kim</span></label>
      </div>

      <div class="group" style="border-left:1px solid rgba(8,12,20,0.04); padding-left:8px;">
        <label title="Khối s"><input type="checkbox" id="showS"/><span id="label_showS">s</span></label>
        <label title="Khối p"><input type="checkbox" id="showP"/><span id="label_showP">p</span></label>
        <label title="Khối d"><input type="checkbox" id="showD"/><span id="label_showD">d</span></label>
        <label title="Khối f"><input type="checkbox" id="showF"/><span id="label_showF">f</span></label>
      </div>

      <div class="group" style="border-left:1px solid rgba(8,12,20,0.04); padding-left:8px;">
        <label title="Cấu hình electron"><input type="checkbox" id="showConfig" checked/><span id="label_showConfig">Cấu hình e</span></label>
      </div>

      <button id="note-btn" class="guide-btn" title="Hướng dẫn"><span id="label_guide">Hướng dẫn</span></button>

      <div class="lang-select" role="group" aria-label="Language">
        <select id="languageSelect" aria-label="Select language">
          <option value="vi">Tiếng Việt</option>
          <option value="en">English</option>
          <option value="zh">中文</option>
          <option value="hi">हिन्दी</option>
          <option value="es">Español</option>
          <option value="fr">Français</option>
          <option value="ru">Русский</option>
          <option value="ar">العربية</option>
        </select>
      </div>
    </div>

    <!-- Popups -->
    <div id="element-popup" role="dialog" aria-hidden="true"></div>

    <div id="note-popup" role="dialog" aria-hidden="true" aria-modal="true">
      <button class="note-close" id="noteClose" aria-label="Close">&times;</button>
      <div class="note-title" id="noteTitle">Hướng dẫn</div>
      <ul id="noteList"></ul>
    </div>

    <script>
      /* ---------------------
         TRANSLATIONS - guide available for all languages
      --------------------- */
      const translations = {
        vi: {
          showMetal: "Kim loại",
          showNonMetal: "Phi kim",
          showNobleGas: "Khí trơ (khí hiếm)",
          showMetalloid: "Á kim",
          showS: "s", showP: "p", showD: "d", showF: "f",
          showConfig: "Cấu hình e",
          guide: "Hướng dẫn",
          noteTitle: "Hướng dẫn",
          noteList: [
            "<li><b>Bấm chuột trái vào ô nguyên tố</b> để mở popup xem thông tin.</li>",
            "<li><b>Đóng popup</b> bằng cách bấm lại ô nguyên tố, bấm vào popup hoặc bấm vào vùng trống.</li>",
            "<li><b>Bấm vào số thứ tự hàng (chu kỳ)</b> để bật/tắt tô sáng hàng.</li>",
            "<li><b>Bấm vào số thứ tự cột (nhóm)</b> để bật/tắt vệt sáng cột (bắt đầu từ vị trí nhóm).</li>",
            "<li><b>Giữ Ctrl (Windows) hoặc Command (Mac) và kéo</b> để dịch chuyển bảng.</li>",
            "<li><b>Dùng con lăn chuột</b> để phóng to/thu nhỏ.</li>",
            "<li><b>Click đúp</b> để đặt lại bảng về trạng thái ban đầu.</li>"
          ],
          atomicNumber: "Số hiệu nguyên tử",
          atomicMass: "Nguyên tử khối",
          covalentRadius: "Bán kính cộng hóa trị",
          electronegativity: "Độ âm điện (Pauling)",
          electronConfig: "Cấu hình e"
        },
        en: {
          showMetal: "Metal",
          showNonMetal: "Non-metal",
          showNobleGas: "Noble gas",
          showMetalloid: "Metalloid",
          showS: "s", showP: "p", showD: "d", showF: "f",
          showConfig: "Electron config",
          guide: "Guide",
          noteTitle: "Guide",
          noteList: [
            "<li><b>Left-click an element</b> to open a details popup.</li>",
            "<li><b>Close the popup</b> by clicking the same element, the popup, or empty space.</li>",
            "<li><b>Click the period number</b> to toggle row highlight.</li>",
            "<li><b>Click the group number</b> to toggle column highlight (starts at the group number).</li>",
            "<li><b>Hold Ctrl (Windows) or Command (Mac) + drag</b> to move the table.</li>",
            "<li><b>Use the mouse wheel</b> to zoom in/out.</li>",
            "<li><b>Double-click</b> to reset the table.</li>"
          ],
          atomicNumber: "Atomic Number",
          atomicMass: "Atomic Mass",
          covalentRadius: "Covalent Radius",
          electronegativity: "Electronegativity (Pauling)",
          electronConfig: "Electron Config"
        },
        zh: {
          showMetal: "金属", showNonMetal: "非金属", showNobleGas: "惰性气体", showMetalloid: "类金属",
          showS: "s", showP: "p", showD: "d", showF: "f",
          showConfig: "电子构型",
          guide: "指南", noteTitle: "指南",
          noteList: [
            "<li><b>左键单击元素</b>以打开详细信息弹窗。</li>",
            "<li><b>关闭弹窗</b>：再次点击该元素、点击弹窗或点击空白处。</li>",
            "<li><b>点击周期号</b>切换整行高亮。</li>",
            "<li><b>点击族号</b>切换整列高亮（从族号处开始）。</li>",
            "<li><b>按住 Ctrl（Windows）或 Command（Mac）并拖动</b>移动表格。</li>",
            "<li><b>使用鼠标滚轮</b>进行缩放。</li>",
            "<li><b>双击</b>重置表格。</li>"
          ],
          atomicNumber: "原子序数", atomicMass: "原子质量", covalentRadius: "共价半径", electronegativity: "电负性 (Pauling)", electronConfig: "电子配置"
        },
        hi: {
          showMetal: "धातु", showNonMetal: "अधातु", showNobleGas: "निष्क्रिय गैसें", showMetalloid: "अर्ध-धातु",
          showS: "s", showP: "p", showD: "d", showF: "f",
          showConfig: "इलेक्ट्रॉन विन्यास",
          guide: "मार्गदर्शिका", noteTitle: "मार्गदर्शिका",
          noteList: [
            "<li><b>किसी तत्व पर बाएँ-क्लिक करें</b> ताकि विवरण पॉपअप खुले।</li>",
            "<li><b>पॉपअप बंद करने</b> के लिए उसी तत्व या पॉपअप या खाली जगह पर क्लिक करें।</li>",
            "<li><b>पीरियड संख्या पर क्लिक करें</b> पूरी पंक्ति को हाइलाइट करने के लिए।</li>",
            "<li><b>ग्रुप संख्या पर क्लिक करें</b> पूरी कॉलम हाइलाइट (ग्रुप संख्या से शुरू)।</li>",
            "<li><b>Ctrl (Windows) या Command (Mac) दबाकर रखें और खींचें</b> तालिका को स्थानांतरित करने के लिए।</li>",
            "<li><b>माउस व्हील का उपयोग करें</b> ज़ूम के लिए।</li>",
            "<li><b>डबल-क्लिक</b> तालिका रीसेट करने के लिए।</li>"
          ],
          atomicNumber: "परमाणु क्रमांक", atomicMass: "परमाणु द्रव्यमान", covalentRadius: "कोवैलेंट त्रिज्या", electronegativity: "इलेक्ट्रोऋणात्मकता", electronConfig: "इलेक्ट्रॉन विन्यास"
        },
        es: {
          showMetal: "Metales", showNonMetal: "No metales", showNobleGas: "Gases nobles", showMetalloid: "Metaloides",
          showS: "s", showP: "p", showD: "d", showF: "f",
          showConfig: "Configuración de electrones",
          guide: "Guía", noteTitle: "Guía",
          noteList: [
            "<li><b>Haz clic izquierdo en un elemento</b> para abrir un popup con detalles.</li>",
            "<li><b>Cierra el popup</b> haciendo clic en el mismo elemento, en el popup o en un área vacía.</li>",
            "<li><b>Haz clic en el número de período</b> para alternar el resaltado de la fila.</li>",
            "<li><b>Haz clic en el número de grupo</b> para alternar el resaltado de la columna (comienza en el número de grupo).</li>",
            "<li><b>Mantén Ctrl (Windows) o Command (Mac) y arrastra</b> para mover la tabla.</li>",
            "<li><b>Usa la rueda del ratón</b> para hacer zoom.</li>",
            "<li><b>Haz doble clic</b> para reiniciar la tabla.</li>"
          ],
          atomicNumber: "Número atómico", atomicMass: "Masa atómica", covalentRadius: "Radio covalente", electronegativity: "Electronegatividad (Pauling)", electronConfig: "Configuración electrónica"
        },
        fr: {
          showMetal: "Métaux", showNonMetal: "Non-métaux", showNobleGas: "Gaz nobles", showMetalloid: "Métalloïdes",
          showS: "s", showP: "p", showD: "d", showF: "f",
          showConfig: "Configuration électronique",
          guide: "Guide", noteTitle: "Guide",
          noteList: [
            "<li><b>Cliquez sur un élément</b> pour ouvrir une fenêtre d'information.</li>",
            "<li><b>Fermez la fenêtre</b> en cliquant sur le même élément, la fenêtre hoặc une zone vide.</li>",
            "<li><b>Cliquez sur le numéro de période</b> pour basculer le surlignage de la ligne.</li>",
            "<li><b>Cliquez sur le numéro de groupe</b> pour basculer le surlignage de la colonne (à partir du numéro).</li>",
            "<li><b>Maintenez Ctrl (Windows) ou Command (Mac) et faites glisser</b> pour déplacer le tableau.</li>",
            "<li><b>Utilisez la molette</b> để zoom.</li>",
            "<li><b>Double-cliquez</b> để khôi phục bảng.</li>"
          ],
          atomicNumber: "Numéro atomique", atomicMass: "Masse atomique", covalentRadius: "Rayon covalent", electronegativity: "Électronégativité (Pauling)", electronConfig: "Configuration électronique"
        },
        ru: {
          showMetal: "Металлы", showNonMetal: "Неметаллы", showNobleGas: "Благородные газы", showMetalloid: "Металлоиды",
          showS: "s", showP: "p", showD: "d", showF: "f",
          showConfig: "Электронная конфигурация",
          guide: "Руководство", noteTitle: "Руководство",
          noteList: [
            "<li><b>Щелкните по элементу</b> чтобы открыть окно с информацией.</li>",
            "<li><b>Закройте окно</b> кликом по тому же элементу, по окну или по пустой области.</li>",
            "<li><b>Нажмите на номер периода</b> чтобы переключить подсветку строки.</li>",
            "<li><b>Нажмите на номер группы</b> чтобы переключнуть подсветку столбца (начиная с номера группы).</li>",
            "<li><b>Удерживайте Ctrl (Windows) или Command (Mac) и перетаскивайте</b> для перемещения таблицы.</li>",
            "<li><b>Используйте колесо мыши</b> для масштабирования.</li>",
            "<li><b>Двойной клик</b> сбрасывает вид.</li>"
          ],
          atomicNumber: "Атомный номер", atomicMass: "Атомная масса", covalentRadius: "Ковалентный радиус", electronegativity: "Электроотрицательность (Pauling)", electronConfig: "Электронная конфигурация"
        },
        ar: {
          showMetal: "المعادن", showNonMetal: "غير المعادن", showNobleGas: "الغازات النبيلة", showMetalloid: "شبه فلزات",
          showS: "s", showP: "p", showD: "d", showF: "f",
          showConfig: "تكوين الإلكترون",
          guide: "الدليل", noteTitle: "الدليل",
          noteList: [
            "<li><b>انقر على عنصر</b> لفتح نافذة التفاصيل.</li>",
            "<li><b>أغلق النافذة</b> بالنقر على نفس العنصر، النافذة أو منطقة فارغة.</li>",
            "<li><b>انقر على رقم الدورة</b> لتبديل تمييز الصف.</li>",
            "<li><b>انقر على رقم المجموعة</b> لتبديل تمييز العمود (يبدأ من رقم المجموعة).</li>",
            "<li><b>اضغط Ctrl (Windows) أو Command (Mac) واسحب</b> لتحريك الجدول.</li>",
            "<li><b>استخدم عجلة الماوس</b> للتكبير/التصغير.</li>",
            "<li><b>انقر مرتين</b> لإعادة تعيين العرض.</li>"
          ],
          atomicNumber: "الرقم الذري", atomicMass: "الكتلة الذرية", covalentRadius: "نصف القطر التساهمي", electronegativity: "السالبية (Pauling)", electronConfig: "تكوين الإلكترون"
        }
      };

      // safe DOM read
      function safeChecked(id){ const el = document.getElementById(id); return el ? !!el.checked : false; }

      // superscript helper
      function toSuperscript(numStr){ return numStr.replace(/\d/g, d => "⁰¹²³⁴⁵⁶⁷⁸⁹"[d]); }
      function formatElectronConfig(config){ return config.replace(/(\d)([spdf])(\d+)/g,(m,n,l,e)=> n + l + toSuperscript(e)); }

      const LANG_INITIAL_FONT_PX = { vi:14,en:14,zh:13,hi:13,es:13,fr:12,ru:11,ar:13 };
      const MIN_FONT_PX = 11;
      const H_MARGIN = 32;
      function setToolbarFontSize(px){ document.documentElement.style.setProperty('--toolbar-font-size', px + 'px'); }
      function setToolbarPadding(padV,padH,gap){ document.documentElement.style.setProperty('--label-padding-vertical', padV + 'px'); document.documentElement.style.setProperty('--label-padding-horizontal', padH + 'px'); document.documentElement.style.setProperty('--toolbar-gap', gap + 'px'); }

      const STAR_COL_IDX = 2, fBlockYOffset = 40;
      const blockColors = { s:"#78d6ff", p:"#ff8b9e", d:"#ffd85c", f:"#8fe4a0", null:"#f2f4f6" };
      const blockHighlight = { s:"#00b7ff", p:"#ff2f55", d:"#ffb400", f:"#1abc4a", null:"#ffffff" };

      const elements = [
        [1,"H","Hydrogen",1.008,"1s1",37,2.20,1,1,"s","IA"],
        [2,"He","Helium",4.002602,"1s2",31,0,18,1,"s","VIIA"],
        [3,"Li","Lithium",6.94,"[He]2s1",134,0.98,1,2,"s","IA"],
        [4,"Be","Beryllium",9.0121831,"[He]2s2",105,1.57,2,2,"s","IIA"],
        [5,"B","Boron",10.81,"[He]2s2 2p1",85,2.04,13,2,"p","IIIA"],
        [6,"C","Carbon",12.011,"[He]2s2 2p2",75,2.55,14,2,"p","IVA"],
        [7,"N","Nitrogen",14.007,"[He]2s2 2p3",70,3.04,15,2,"p","VA"],
        [8,"O","Oxygen",15.999,"[He]2s2 2p4",66,3.44,16,2,"p","VIA"],
        [9,"F","Fluorine",18.998403163,"[He]2s2 2p5",57,3.98,17,2,"p","VIIA"],
        [10,"Ne","Neon",20.1797,"[He]2s2 2p6",58,0,18,2,"p","VIIA"],
        [11,"Na","Sodium",22.98976928,"[Ne]3s1",154,0.93,1,3,"s","IA"],
        [12,"Mg","Magnesium",24.305,"[Ne]3s2",130,1.31,2,3,"s","IIA"],
        [13,"Al","Aluminium",26.9815385,"[Ne]3s2 3p1",118,1.61,13,3,"p","IIIA"],
        [14,"Si","Silicon",28.085,"[Ne]3s2 3p2",111,1.90,14,3,"p","IVA"],
        [15,"P","Phosphorus",30.973761998,"[Ne]3s2 3p3",107,2.19,15,3,"p","VA"],
        [16,"S","Sulfur",32.06,"[Ne]3s2 3p4",105,2.58,16,3,"p","VIA"],
        [17,"Cl","Chlorine",35.45,"[Ne]3s2 3p5",102,3.16,17,3,"p","VIIA"],
        [18,"Ar","Argon",39.948,"[Ne]3s2 3p6",106,0,18,3,"p","VIIA"],
        [19,"K","Potassium",39.0983,"[Ar]4s1",196,0.82,1,4,"s","IA"],
        [20,"Ca","Calcium",40.078,"[Ar]4s2",174,1.00,2,4,"s","IIA"],
        [21,"Sc","Scandium",44.955908,"[Ar]3d1 4s2",144,1.36,3,4,"d","IIIB"],
        [22,"Ti","Titanium",47.867,"[Ar]3d2 4s2",136,1.54,4,4,"d","IVB"],
        [23,"V","Vanadium",50.9415,"[Ar]3d3 4s2",131,1.63,5,4,"d","VB"],
        [24,"Cr","Chromium",51.9961,"[Ar]3d5 4s1",128,1.66,6,4,"d","VIB"],
        [25,"Mn","Manganese",54.938044,"[Ar]3d5 4s2",127,1.55,7,4,"d","VIIB"],
        [26,"Fe","Iron",55.845,"[Ar]3d6 4s2",126,1.83,8,4,"d","VIIIB"],
        [27,"Co","Cobalt",58.933194,"[Ar]3d7 4s2",125,1.88,9,4,"d","VIIIB"],
        [28,"Ni","Nickel",58.6934,"[Ar]3d8 4s2",124,1.91,10,4,"d","VIIIB"],
        [29,"Cu","Copper",63.546,"[Ar]3d10 4s1",132,1.90,11,4,"d","IB"],
        [30,"Zn","Zinc",65.38,"[Ar]3d10 4s2",131,1.65,12,4,"d","IIB"],
        [31,"Ga","Gallium",69.723,"[Ar]3d10 4s2 4p1",122,1.81,13,4,"p","IIIA"],
        [32,"Ge","Germanium",72.63,"[Ar]3d10 4s2 4p2",122,2.01,14,4,"p","IVA"],
        [33,"As","Arsenic",74.921595,"[Ar]3d10 4s2 4p3",119,2.18,15,4,"p","VA"],
        [34,"Se","Selenium",78.971,"[Ar]3d10 4s2 4p4",116,2.55,16,4,"p","VIA"],
        [35,"Br","Bromine",79.904,"[Ar]3d10 4s2 4p5",114,2.96,17,4,"p","VIIA"],
        [36,"Kr","Krypton",83.798,"[Ar]3d10 4s2 4p6",116,3.00,18,4,"p","VIIIA"],
        [37,"Rb","Rubidium",85.4678,"[Kr]5s1",211,0.82,1,5,"s","IA"],
        [38,"Sr","Strontium",87.62,"[Kr]5s2",194,0.95,2,5,"s","IIA"],
        [39,"Y","Yttrium",88.90584,"[Kr]4d1 5s2",180,1.22,3,5,"d","IIIB"],
        [40,"Zr","Zirconium",91.224,"[Kr]4d2 5s2",160,1.33,4,5,"d","IVB"],
        [41,"Nb","Niobium",92.90637,"[Kr]4d4 5s1",146,1.60,5,5,"d","VB"],
        [42,"Mo","Molybdenum",95.95,"[Kr]4d5 5s1",139,2.16,6,5,"d","VIB"],
        [43,"Tc","Technetium",98,"[Kr]4d5 5s2",136,1.90,7,5,"d","VIIB"],
        [44,"Ru","Ruthenium",101.07,"[Kr]4d7 5s1",134,2.20,8,5,"d","VIIIB"],
        [45,"Rh","Rhodium",102.91,"[Kr]4d8 5s1",134,2.28,9,5,"d","VIIIB"],
        [46,"Pd","Palladium",106.42,"[Kr]4d10",137,2.20,10,5,"d","VIIIB"],
        [47,"Ag","Silver",107.87,"[Kr]4d10 5s1",145,1.93,11,5,"d","IB"],
        [48,"Cd","Cadmium",112.41,"[Kr]4d10 5s2",144,1.69,12,5,"d","IIB"],
        [49,"In","Indium",114.82,"[Kr]4d10 5s2 5p1",167,1.78,13,5,"p","IIIA"],
        [50,"Sn","Tin",118.71,"[Kr]4d10 5s2 5p2",140,1.96,14,5,"p","IVA"],
        [51,"Sb","Antimony",121.76,"[Kr]4d10 5s2 5p3",133,2.05,15,5,"p","VA"],
        [52,"Te","Tellurium",127.60,"[Kr]4d10 5s2 5p4",123,2.10,16,5,"p","VIA"],
        [53,"I","Iodine",126.90,"[Kr]4d10 5s2 5p5",122,2.66,17,5,"p","VIIA"],
        [54,"Xe","Xenon",131.293,"[Kr]4d10 5s2 5p6",108,2.60,18,5,"p","VIIIA"],
        [55,"Cs","Cesium",132.90545196,"[Xe]6s1",232,0.79,1,6,"s","IA"],
        [56,"Ba","Barium",137.327,"[Xe]6s2",196,0.89,2,6,"s","IIA"],
        [57,"La","Lanthanum",138.90547,"[Xe]5d1 6s2",187,1.10,3,6,"d","IIIB"],
        [58,"Ce","Cerium",140.116,"[Xe]4f1 5d1 6s2",182,1.12,null,6,"f",""],
        [59,"Pr","Praseodymium",140.90766,"[Xe]4f3 6s2",182,1.13,null,6,"f",""],
        [60,"Nd","Neodymium",144.242,"[Xe]4f4 6s2",182,1.14,null,6,"f",""],
        [61,"Pm","Promethium",145,"[Xe]4f5 6s2",182,1.13,null,6,"f",""],
        [62,"Sm","Samarium",150.36,"[Xe]4f6 6s2",180,1.17,null,6,"f",""],
        [63,"Eu","Europium",151.964,"[Xe]4f7 6s2",199,1.20,null,6,"f",""],
        [64,"Gd","Gadolinium",157.25,"[Xe]4f7 5d1 6s2",180,1.20,null,6,"f",""],
        [65,"Tb","Terbium",158.92535,"[Xe]4f9 6s2",177,1.10,null,6,"f",""],
        [66,"Dy","Dysprosium",162.500,"[Xe]4f10 6s2",178,1.22,null,6,"f",""],
        [67,"Ho","Holmium",164.93033,"[Xe]4f11 6s2",176,1.23,null,6,"f",""],
        [68,"Er","Erbium",167.259,"[Xe]4f12 6s2",175,1.24,null,6,"f",""],
        [69,"Tm","Thulium",168.93422,"[Xe]4f13 6s2",169,1.25,null,6,"f",""],
        [70,"Yb","Ytterbium",173.054,"[Xe]4f14 6s2",194,1.10,3,6,"f",""],
        [71,"Lu","Lutetium",174.9668,"[Xe]4f14 5d1 6s2",160,1.27,null,6,"f",""],
        [72,"Hf","Hafnium",178.49,"[Xe]4f14 5d2 6s2",150,1.30,4,6,"d","IVB"],
        [73,"Ta","Tantalum",180.94788,"[Xe]4f14 5d3 6s2",146,1.50,5,6,"d","VB"],
        [74,"W","Tungsten",183.84,"[Xe]4f14 5d4 6s2",135,2.36,6,6,"d","VIB"],
        [75,"Re","Rhenium",186.207,"[Xe]4f14 5d5 6s2",137,1.90,7,6,"d","VIIB"],
        [76,"Os","Osmium",190.23,"[Xe]4f14 5d6 6s2",135,2.20,8,6,"d","VIIIB"],
        [77,"Ir","Iridium",192.217,"[Xe]4f14 5d7 6s2",136,2.20,9,6,"d","VIIIB"],
        [78,"Pt","Platinum",195.084,"[Xe]4f14 5d9 6s1",137,2.28,10,6,"d","VIIIB"],
        [79,"Au","Gold",196.966569,"[Xe]4f14 5d10 6s1",144,2.54,11,6,"d","IB"],
        [80,"Hg","Mercury",200.592,"[Xe]4f14 5d10 6s2",151,2.00,12,6,"d","IIB"],
        [81,"Tl","Thallium",204.38,"[Xe]4f14 5d10 6s2 6p1",156,1.62,13,6,"p","IIIA"],
        [82,"Pb","Lead",207.2,"[Xe]4f14 5d10 6s2 6p2",154,2.33,14,6,"p","IVA"],
        [83,"Bi","Bismuth",208.98040,"[Xe]4f14 5d10 6s2 6p3",143,2.02,15,6,"p","VA"],
        [84,"Po","Polonium",209,"[Xe]4f14 5d10 6s2 6p4",135,2.0,16,6,"p","VIA"],
        [85,"At","Astatine",210,"[Xe]4f14 5d10 6s2 6p5",150,2.2,17,6,"p","VIIA"],
        [86,"Rn","Radon",222,"[Xe]4f14 5d10 6s2 6p6",140,0,18,6,"p","VIIIA"],
        [87,"Fr","Francium",223,"[Rn]7s1",348,0.7,1,7,"s","IA"],
        [88,"Ra","Radium",226,"[Rn]7s2",283,0.9,2,7,"s","IIA"],
        [89,"Ac","Actinium",227,"[Rn]6d1 7s2",215,1.10,3,7,"d","IIIB"],
        [90,"Th","Thorium",232.0377,"[Rn]6d2 7s2",267,1.3,null,7,"f",""],
        [91,"Pa","Protactinium",231.03588,"[Rn]5f2 6d1 7s2",262,1.5,null,7,"f",""],
        [92,"U","Uranium",238.02891,"[Rn]5f3 6d1 7s2",268,1.38,null,7,"f",""],
        [93,"Np","Neptunium",237,"[Rn]5f4 6d1 7s2",275,1.36,null,7,"f",""],
        [94,"Pu","Plutonium",244,"[Rn]5f6 7s2",244,1.28,null,7,"f",""],
        [95,"Am","Americium",243,"[Rn]5f7 7s2",248,1.30,null,7,"f",""],
        [96,"Cm","Curium",247,"[Rn]5f7 6d1 7s2",247,1.30,null,7,"f",""],
        [97,"Bk","Berkelium",247,"[Rn]5f9 7s2",244,1.30,null,7,"f",""],
        [98,"Cf","Californium",251,"[Rn]5f10 7s2",243,1.30,null,7,"f",""],
        [99,"Es","Einsteinium",252,"[Rn]5f11 7s2",242,1.30,null,7,"f",""],
        [100,"Fm","Fermium",257,"[Rn]5f12 7s2",240,1.30,null,7,"f",""],
        [101,"Md","Mendelevium",258,"[Rn]5f13 7s2",238,1.30,null,7,"f",""],
        [102,"No","Nobelium",259,"[Rn]5f14 7s2",237,1.30,3,7,"f",""],
        [103,"Lr","Lawrencium",266,"[Rn]5f14 7s2 7p1",243,1.30,null,7,"f",""],
        [104,"Rf","Rutherfordium",267,"[Rn]5f14 6d2 7s2",0,0,4,7,"d","IVB"],
        [105,"Db","Dubnium",268,"[Rn]5f14 6d3 7s2",0,0,5,7,"d","VB"],
        [106,"Sg","Seaborgium",269,"[Rn]5f14 6d4 7s2",0,0,6,7,"d","VIB"],
        [107,"Bh","Bohrium",270,"[Rn]5f14 6d5 7s2",0,0,7,7,"d","VIIB"],
        [108,"Hs","Hassium",277,"[Rn]5f14 6d6 7s2",0,0,8,7,"d","VIIIB"],
        [109,"Mt","Meitnerium",278,"[Rn]5f14 6d7 7s2",0,0,9,7,"d","VIIIB"],
        [110,"Ds","Darmstadtium",281,"[Rn]5f14 6d8 7s2",0,0,10,7,"d","VIIIB"],
        [111,"Rg","Roentgenium",282,"[Rn]5f14 6d9 7s2",0,0,11,7,"d","IB"],
        [112,"Cn","Copernicium",285,"[Rn]5f14 6d10 7s2",0,0,12,7,"d","IIB"],
        [113,"Nh","Nihonium",286,"[Rn]5f14 6d10 7s2 7p1",0,0,13,7,"p","IIIA"],
        [114,"Fl","Flerovium",289,"[Rn]5f14 6d10 7s2 7p2",0,0,14,7,"p","IVA"],
        [115,"Mc","Moscovium",290,"[Rn]5f14 6d10 7s2 7p3",0,0,15,7,"p","VA"],
        [116,"Lv","Livermorium",293,"[Rn]5f14 6d10 7s2 7p4",0,0,16,7,"p","VIA"],
        [117,"Ts","Tennessine",294,"[Rn]5f14 6d10 7s2 7p5",0,0,17,7,"p","VIIA"],
        [118,"Og","Oganesson",294,"[Rn]5f14 6d10 7s2 7p6",0,0,18,7,"p","VIIIA"]
      ];

      const nonMetals = new Set(["H","C","N","O","F","P","S","Cl","Se","Br","I"]);
      const nobleGases = new Set(["He","Ne","Ar","Kr","Xe","Rn","Og"]);
      const metalloidsSet = new Set(["B","Si","Ge","As","Sb","Te"]);
      function isNonMetal(sym){ return nonMetals.has(sym); }
      function isMetal(sym){ return !nonMetals.has(sym) && !nobleGases.has(sym) && !metalloidsSet.has(sym); }

      // state/layout
      let camX = 0, camY = 0, zoom = 1;
      let dragging = false, dragX, dragY, startCamX, startCamY;
      let highlightedRow = null, highlightedColGroup = null;
      let cellW, cellH, margin, yOffset, xOffset, starColW, rowStartOffset = 0;
      let selected = null, hoveredIndex = null, manualToggle = false;

      let rowHighlightAlpha = 0, colHighlightAlpha = 0;
      let lastHighlightedRow = null, lastHighlightedColGroup = null;
      const ACCENT_RGB = "14,165,233";

      function setCellSize(){
        const W = window.innerWidth, H = window.innerHeight;
        const isLandscape = W > H;
        const multiplier = (W < 600) ? (isLandscape ? 0.75 : 0.92) : 1;
        cellW = Math.max(36, Math.floor(multiplier * (W - 56) / 19));
        cellH = Math.max(40, Math.floor(multiplier * (H - 140) / 10));
        starColW = cellW * 0.42;
        margin = Math.max(6, Math.min(cellW,cellH) * 0.16);
        if (W < 600) {
          if (isLandscape) { yOffset = 40; rowStartOffset = cellH * 0.18; xOffset = Math.max(20, margin * 4); }
          else { yOffset = 60; rowStartOffset = cellH * 0.25; xOffset = Math.max(36, margin * 6); }
        } else { yOffset = 140; rowStartOffset = cellH * 0.5; xOffset = Math.max(20, margin * 4); }
      }

      function computeColX(){
        const colX = []; let tmpX = xOffset;
        for (let g=1; g<=2; g++){ colX.push(tmpX); tmpX += cellW; }
        colX.push(tmpX); tmpX += starColW;
        for (let g=3; g<=18; g++){ colX.push(tmpX); tmpX += cellW; }
        let temp = colX[2]; colX[2] = colX[3]; colX[3] = temp;
        return colX;
      }
      function groupToDrawCol(group){ return group <= 2 ? group - 1 : group; }

      function fitTableToScreen(){
        const colCount = 19;
        const tableWidth = cellW * (colCount - 1) + starColW + 2 * xOffset;
        const tableHeight = 10 * cellH + fBlockYOffset + 60 + rowStartOffset;
        const availWidth = window.innerWidth, availHeight = window.innerHeight - yOffset - 12;
        const scaleX = availWidth / tableWidth, scaleY = availHeight / tableHeight;
        const factor = ((window.innerWidth < 600 && window.innerWidth > window.innerHeight) ? 1.06 : 1) * 1.08;
        zoom = Math.min(scaleX, scaleY, 1) * factor;
        camX = -(tableWidth * zoom - availWidth) / 2;
        camY = -(tableHeight * zoom - availHeight) / 2 + 10;
      }

      function setup(){
        pixelDensity(window.devicePixelRatio);
        setCellSize();
        createCanvas(window.innerWidth, window.innerHeight);
        textFont("Inter, Arial");
        textAlign(CENTER, CENTER);
        fitTableToScreen();
      }

      function draw(){
        background(255);
        translate(camX, yOffset + camY);
        scale(zoom);
        drawTable();
        drawStars();

        if (selected !== null && document.getElementById("element-popup") && document.getElementById("element-popup").style.display !== "none") setDefaultElementPopupPosition(selected);
        if (document.getElementById("note-popup") && document.getElementById("note-popup").style.display !== "none"){
          const n = document.getElementById("note-popup");
          n.style.transformOrigin = "top left";
          n.style.transform = `scale(${Math.min(1, zoom)})`;
        }
      }

      function windowResized(){ setCellSize(); resizeCanvas(window.innerWidth, window.innerHeight); fitTableToScreen(); adjustToolbarAfterLayout(); }

      // drawTable: draw group numbers -> column highlight -> row highlight -> elements -> row numbers (top)
      function drawTable(){
        fill(60); textAlign(CENTER,CENTER);
        const colNumberFont = cellH * 0.35, rowNumberFont = cellH * 0.35;
        textSize(colNumberFont);
        const colX = computeColX();

        if (highlightedRow !== null) lastHighlightedRow = highlightedRow;
        if (highlightedColGroup !== null) lastHighlightedColGroup = highlightedColGroup;

        const targetRowAlpha = highlightedRow ? 0.22 : 0.0;
        const targetColAlpha = highlightedColGroup ? 0.22 : 0.0;
        rowHighlightAlpha += (targetRowAlpha - rowHighlightAlpha) * 0.14;
        colHighlightAlpha += (targetColAlpha - colHighlightAlpha) * 0.14;

        const groupNumberY = -cellH * 0.7;

        // 1) Draw group numbers & labels (so column highlight can overlay them)
        fill(60); textSize(colNumberFont);
        let tmpX = xOffset;
        for (let g=1; g<=2; g++){ text(g, tmpX + cellW/2, groupNumberY); tmpX += cellW; }
        tmpX += starColW;
        for (let g=3; g<=18; g++){ const idx = groupToDrawCol(g); text(g, colX[idx] + cellW/2, groupNumberY); }

        textSize(colNumberFont * 0.8);
        [1,2,13,14,15,16,17,18].forEach(g=>{
          const idx = groupToDrawCol(g);
          const label = ({1:"IA",2:"IIA",13:"IIIA",14:"IVA",15:"VA",16:"VIA",17:"VIIA",18:"VIIIA"})[g] || "";
          text(label, colX[idx] + cellW/2, -cellH * 0.18);
        });
        [3,4,5,6,7,8,9,10,11,12].forEach(g=>{
          const idx = groupToDrawCol(g);
          const label = ({3:"IIIB",4:"IVB",5:"VB",6:"VIB",7:"VIIB",8:"VIIIB",9:"VIIIB",10:"VIIIB",11:"IB",12:"IIB"})[g];
          text(label, colX[idx] + cellW/2, -cellH * 0.18);
        });

        // 2) Column highlight draws next (OVER group numbers, but UNDER elements)
        if (colHighlightAlpha > 0.005 && lastHighlightedColGroup !== null){
          const idx = groupToDrawCol(lastHighlightedColGroup);
          const colLeft = colX[idx] + 6;
          const colWidth = ((idx === STAR_COL_IDX) ? starColW : cellW) - 12;
          const numBoxHeight = colNumberFont * 1.2;
          const extraUp = Math.max(8, Math.round(cellH * 0.08));
          const highlightTop = groupNumberY - (numBoxHeight * 1.12) - extraUp;
          const highlightHeight = rowStartOffset + 7 * cellH - highlightTop + 6;

          drawingContext.save();
          drawingContext.shadowBlur = 18 * (colHighlightAlpha / 0.22);
          drawingContext.shadowColor = `rgba(${ACCENT_RGB}, ${Math.min(0.35, colHighlightAlpha)})`;
          noStroke();
          fill(`rgba(${ACCENT_RGB}, ${colHighlightAlpha})`);
          rect(colLeft, highlightTop + 6, colWidth, Math.max(0, highlightHeight - 12), 10);
          drawingContext.restore();

          stroke(`rgba(${ACCENT_RGB}, ${Math.min(0.6, colHighlightAlpha * 1.2)})`);
          strokeWeight(1.6);
          noFill();
          rect(colLeft, highlightTop + 6, colWidth, Math.max(0, highlightHeight - 12), 10);
          noStroke();
        }

        // 3) Row highlight draws BEFORE elements so elements remain on top
        if (rowHighlightAlpha > 0.005 && lastHighlightedRow !== null){
          const r = lastHighlightedRow;
          const ry = (r - 1) * cellH + rowStartOffset + 6;
          const rw = cellW * 19 - 12;
          const rx = xOffset - cellW*1.25 + 6;
          drawingContext.save();
          drawingContext.shadowBlur = 18 * (rowHighlightAlpha / 0.22);
          drawingContext.shadowColor = `rgba(${ACCENT_RGB}, ${Math.min(0.35, rowHighlightAlpha)})`;
          noStroke();
          fill(`rgba(${ACCENT_RGB}, ${rowHighlightAlpha})`);
          rect(rx, ry, rw, cellH - 12, 10);
          drawingContext.restore();

          stroke(`rgba(${ACCENT_RGB}, ${Math.min(0.6, rowHighlightAlpha * 1.2)})`);
          strokeWeight(1.6);
          noFill();
          rect(rx, ry, rw, cellH - 12, 10);
          noStroke();
        }

        // 4) Draw element cells ON TOP of highlights
        const filterMetal = safeChecked("showMetal");
        const filterNonMetal = safeChecked("showNonMetal");
        const filterNoble = safeChecked("showNobleGas");
        const filterMetalloid = safeChecked("showMetalloid");
        const blockS = safeChecked("showS");
        const blockP = safeChecked("showP");
        const blockD = safeChecked("showD");
        const blockF = safeChecked("showF");
        const showConfig = safeChecked("showConfig");

        const blocksSelectedCount = (blockS?1:0) + (blockP?1:0) + (blockD?1:0) + (blockF?1:0);
        const blocksPartial = blocksSelectedCount > 0 && blocksSelectedCount < 4;
        const anyFilterActive = filterMetal || filterNonMetal || filterNoble || filterMetalloid || blocksPartial || (blockS||blockP||blockD||blockF);

        let fIdx6 = 0, fIdx7 = 0;
        for (let i=0;i<elements.length;i++){
          let [Z,sym,name,mass,config,covRadius,electronegativity,group,period,block] = elements[i];
          let x,y,w;
          if (block === "f"){
            if (period === 6){ x = fIdx6 * cellW + colX[STAR_COL_IDX + 1]; y = 7*cellH + fBlockYOffset + rowStartOffset; w = cellW; fIdx6++; }
            else { x = fIdx7 * cellW + colX[STAR_COL_IDX + 1]; y = 8*cellH + fBlockYOffset + rowStartOffset; w = cellW; fIdx7++; }
          } else if (group !== null){
            const colIdx = groupToDrawCol(group);
            x = colX[colIdx];
            y = (period - 1) * cellH + rowStartOffset;
            w = (colIdx === STAR_COL_IDX) ? starColW : cellW;
          } else continue;
          elements[i][11] = x; elements[i][12] = y; elements[i][13] = w;

          const effectiveBlock = (Z === 57 || Z === 89) ? "f" : block;

          const matchesMetalloid = metalloidsSet.has(sym);
          const matchesMetal = isMetal(sym);
          const matchesNon = isNonMetal(sym);
          const matchesNoble = nobleGases.has(sym);
          const matchesBlockSelected = (effectiveBlock === 's' && blockS) || (effectiveBlock === 'p' && blockP) || (effectiveBlock === 'd' && blockD) || (effectiveBlock === 'f' && blockF);

          const emphasized = (filterMetalloid && matchesMetalloid) ||
                              (filterMetal && matchesMetal) ||
                              (filterNonMetal && matchesNon) ||
                              (filterNoble && matchesNoble) ||
                              (blocksPartial && matchesBlockSelected);

          let baseCol = color(blockColors[effectiveBlock] || blockColors.null);

          if (!anyFilterActive){
            // default
          } else {
            if (emphasized){
              if (filterMetalloid && matchesMetalloid) baseCol = color("#ffdca8");
              else baseCol = color(blockHighlight[effectiveBlock] || "#ffffff");
            } else {
              baseCol = lerpColor(color(blockColors[effectiveBlock] || blockColors.null), color("#ffffff"), 0.88);
            }
          }

          let colHighlight = highlightedColGroup !== null && group === highlightedColGroup && period >= 1 && period <= 7;
          if (highlightedColGroup === 3 && (Z === 70 || Z === 102)) colHighlight = false;
          const isHighlight = (highlightedRow !== null && period === highlightedRow) || colHighlight;

          if (selected === i || hoveredIndex === i || isHighlight){
            fill("#fff7e0"); stroke("#ff8a00"); strokeWeight(3);
          } else {
            fill(baseCol); stroke("#c7cdd6"); strokeWeight(1.25);
          }

          rect(x, y, w - 2, cellH - 2, 10);
          fill(18); noStroke();
          textSize(cellH * 0.36); textAlign(CENTER, CENTER); text(sym, x + w/2, y + cellH * 0.45);
          textSize(cellH * 0.14); textAlign(CENTER, CENTER); text(Z, x + w/2 - (w * 0.35), y + cellH * 0.20);
          textSize(cellH * 0.12); textAlign(RIGHT, CENTER); text(Number(mass).toFixed(4), x + w - 6, y + cellH * 0.20);
          textSize(cellH * 0.12); textAlign(CENTER, CENTER); text(name, x + w/2, y + cellH * 0.70);
          if (showConfig){
            textSize(cellH * 0.095); textAlign(CENTER, CENTER);
            text(formatElectronConfig(config), x + w/2, y + cellH * 0.82);
          }
        }

        // 5) Row numbers last so they remain visible above everything
        textSize(rowNumberFont);
        fill(60);
        for (let p=1; p<=7; p++){
          text(p, xOffset - cellW * 0.60, (p-1)*cellH + cellH/2 + rowStartOffset);
        }

        // legend
        const bottomY = (8 * cellH + fBlockYOffset + rowStartOffset) + 90;
        const tableWidth = cellW * 18 + starColW + xOffset;
        let legendX = xOffset;
        textAlign(LEFT, CENTER); textSize(cellH * 0.34);
        function drawLegendItem(colorVal,labelText){
          fill(colorVal); noStroke();
          rect(legendX, bottomY - (cellH * 0.34) * 0.5, cellH * 0.34, cellH * 0.34, 6);
          legendX += cellH * 0.34 + 8;
          fill(28);
          text(labelText, legendX, bottomY);
          legendX += textWidth(labelText) + 18;
        }
        drawLegendItem(blockColors.s, "s");
        drawLegendItem(blockColors.p, "p");
        drawLegendItem(blockColors.d, "d");
        drawLegendItem(blockColors.f, "f");
        textAlign(RIGHT, CENTER); textSize(cellH * 0.34); fill(70);
        text("© HOÁ HỌC ABC", tableWidth - 10, bottomY);
      }

      function drawStars(){ textAlign(CENTER,CENTER); textSize(cellH * 0.28); }

      /* ---------------------
         Interactions & UI (unchanged)
      --------------------- */
      function getHeaderColAt(mx,my){
        if (my < -cellH || my > 0) return null;
        const colX = computeColX();
        for (let i=0;i<colX.length;i++){
          if (i === STAR_COL_IDX) continue;
          const width = (i === STAR_COL_IDX) ? starColW : cellW;
          if (mx >= colX[i] && mx < colX[i] + width) return i < STAR_COL_IDX ? i+1 : i;
        }
        return null;
      }

      function setDefaultElementPopupPosition(idx){
        const popup = document.getElementById("element-popup");
        const popupRect = popup.getBoundingClientRect();
        const pw = popupRect.width || 300, ph = popupRect.height || 150;
        const elemCanvasX = elements[idx][11], elemCanvasY = elements[idx][12], elemCanvasW = elements[idx][13] || cellW, elemCanvasH = cellH;
        const screenX_center = (elemCanvasX + elemCanvasW/2) * zoom + camX;
        const screenY_top = elemCanvasY * zoom + yOffset + camY;
        const screenY_bottom = (elemCanvasY + elemCanvasH) * zoom + yOffset + camY;
        const gap = 10;
        const toolbarRect = document.getElementById("toolbar").getBoundingClientRect();
        const toolbarBottom = toolbarRect?.bottom || 0;
        let target_px, target_py;
        const py_above = screenY_top - ph - gap;
        if (py_above > toolbarBottom + gap) { target_py = py_above; target_px = screenX_center - pw/2; }
        else { target_py = screenY_bottom + gap; target_px = screenX_center - pw/2; }
        const final_px = Math.max(8, Math.min(window.innerWidth - pw - 8, target_px));
        const final_py = Math.max(toolbarBottom + gap, Math.min(window.innerHeight - ph - 8, target_py));
        popup.style.left = final_px + "px"; popup.style.top = final_py + "px";
        popup.style.transformOrigin = "top left"; popup.style.transform = `scale(${Math.min(1,zoom)})`;
      }

      function showInfoPopup(idx){
        const popup = document.getElementById("element-popup");
        if (!popup) return;
        if (idx === null || idx < 0 || idx >= elements.length){ popup.style.display = "none"; popup.setAttribute("aria-hidden","true"); return; }
        const [Z,sym,name,mass,config,covalentRadius,electronegativity] = elements[idx];
        const dict = translations[currentLang] || translations.vi;
        popup.innerHTML = `
          <div class="popup-title">${sym} • ${name}</div>
          <div class="meta">${dict.atomicNumber || "Số hiệu nguyên tử"}: <strong>${Z}</strong></div>
          <div class="meta">${dict.atomicMass || "Nguyên tử khối"}: ${Number(mass).toFixed(4)}</div>
          <div class="meta">${dict.covalentRadius || "Bán kính cộng hóa trị"}: ${(!covalentRadius ? "N/A" : covalentRadius + " pm")}</div>
          <div class="meta">${dict.electronegativity || "Độ âm điện (Pauling)"}: ${(!electronegativity ? "N/A" : electronegativity)}</div>
          ${safeChecked("showConfig") ? `<div class="meta">${dict.electronConfig || "Cấu hình e"}: ${formatElectronConfig(config)}</div>` : ""}
        `;
        popup.style.display = "block"; popup.setAttribute("aria-hidden","false");
        setDefaultElementPopupPosition(idx);
        requestAnimationFrame(()=>setDefaultElementPopupPosition(idx));
      }

      function mousePressed(e){
        const toolbarRect = document.getElementById("toolbar").getBoundingClientRect();
        if ( mouseY >= toolbarRect.top && mouseY <= toolbarRect.bottom && mouseX >= toolbarRect.left && mouseX <= toolbarRect.right ) return;

        const notePopup = document.getElementById("note-popup");
        const noteRect = notePopup.getBoundingClientRect();
        const clickedOnNote = notePopup.style.display !== "none" && mouseX >= noteRect.left && mouseX <= noteRect.right && mouseY >= noteRect.top && mouseY <= noteRect.bottom;
        if (!clickedOnNote) notePopup.style.display = "none";

        const mx = (mouseX - camX) / zoom;
        const my = (mouseY - yOffset - camY) / zoom;
        const isMac = navigator.platform.toUpperCase().indexOf("MAC") !== -1;

        if (mouseButton === LEFT && ((isMac && e.metaKey) || (!isMac && e.ctrlKey))){
          dragging = true; dragX = mouseX; dragY = mouseY; startCamX = camX; startCamY = camY; return;
        }

        const colGroup = getHeaderColAt(mx,my);
        if (colGroup !== null){
          highlightedColGroup = (highlightedColGroup === colGroup) ? null : colGroup;
          highlightedRow = null; selected = null; showInfoPopup(null); manualToggle = false;
          if (highlightedColGroup !== null) lastHighlightedColGroup = highlightedColGroup;
          return;
        }

        let rowHit = null;
        for (let p=1; p<=7; p++){
          const centerX = xOffset - cellW * 0.6;
          const centerY = (p-1)*cellH + rowStartOffset + cellH/2;
          if (dist(mx,my,centerX,centerY) < cellW * 0.4){ rowHit = p; break; }
        }
        if (rowHit !== null){
          highlightedRow = (highlightedRow === rowHit) ? null : rowHit;
          highlightedColGroup = null; selected = null; showInfoPopup(null); manualToggle = false;
          if (highlightedRow !== null) lastHighlightedRow = highlightedRow;
          return;
        }

        let clickedElement = false;
        for (let i=0;i<elements.length;i++){
          const ex = elements[i][11], ey = elements[i][12], ew = elements[i][13] || cellW;
          if (mx >= ex && mx < ex + ew && my >= ey && my < ey + cellH){
            if (selected === i){ selected = null; showInfoPopup(null); manualToggle = false; }
            else { selected = i; manualToggle = true; showInfoPopup(selected); }
            clickedElement = true; break;
          }
        }
        if (!clickedElement){
          selected = null; highlightedRow = null; highlightedColGroup = null; manualToggle = false; showInfoPopup(null);
        }
        hoveredIndex = null;
      }

      function mouseDragged(){ if (dragging){ camX = startCamX + (mouseX - dragX); camY = startCamY + (mouseY - dragY); } }
      function mouseReleased(){ dragging = false; }

      function mouseWheel(e){
        const notePopup = document.getElementById("note-popup");
        const noteRect = notePopup.getBoundingClientRect();
        const mouseOnNote = notePopup.style.display !== "none" && mouseX >= noteRect.left && mouseX <= noteRect.right && mouseY >= noteRect.top && mouseY <= noteRect.bottom;
        if (mouseOnNote) return false;
        const scale0 = zoom;
        zoom *= (e.delta > 0) ? 0.88 : 1.12;
        zoom = Math.max(0.05, Math.min(10, zoom));
        const wx = (mouseX - camX) / scale0, wy = (mouseY - yOffset - camY) / scale0;
        camX -= (zoom - scale0) * wx;
        camY -= (zoom - scale0) * wy;
        if (selected !== null) showInfoPopup(selected);
        if (notePopup.style.display !== "none"){ notePopup.style.transformOrigin = "top left"; notePopup.style.transform = `scale(${Math.min(1,zoom)})`; }
        return false;
      }

      function mouseMoved(){
        if (manualToggle) return;
        const mx = (mouseX - camX) / zoom;
        const my = (mouseY - yOffset - camY) / zoom;
        let newHoveredIndex = null;
        for (let i=0;i<elements.length;i++){
          const ex = elements[i][11], ey = elements[i][12], ew = elements[i][13] || cellW;
          if (mx >= ex && mx < ex + ew && my >= ey && my < ey + cellH){ newHoveredIndex = i; break; }
        }
        hoveredIndex = newHoveredIndex;
      }

      function doubleClicked(){
        fitTableToScreen();
        selected = null; manualToggle = false; highlightedRow = null; highlightedColGroup = null;
        const popup = document.getElementById("element-popup");
        if (popup) popup.style.display = "none";
        return false;
      }

      /* ---------------------
         UI: language, note popup, draggables
      --------------------- */
      let currentLang = "vi";
      document.addEventListener("DOMContentLoaded", ()=>{
        const langSel = document.getElementById("languageSelect");
        langSel.addEventListener("change", () => { updateLanguage(); adjustToolbarAfterLayout(); });

        document.getElementById("note-btn").addEventListener("click", ()=>{
          const n = document.getElementById("note-popup");
          if (n.style.display === "block"){ n.style.display = "none"; }
          else { document.getElementById("element-popup").style.display = "none"; selected = null; manualToggle = false; n.style.display = "block"; positionNotePopup(); }
        });

        document.getElementById("noteClose").addEventListener("click", (e)=>{ e.stopPropagation(); document.getElementById("note-popup").style.display = "none"; });

        makeDraggable(document.getElementById("note-popup"), { check: (e) => !e.target.classList.contains("note-close") });
        makeDraggable(document.getElementById("element-popup"));

        ["showMetal","showNonMetal","showNobleGas","showMetalloid","showS","showP","showD","showF","showConfig"].forEach(id=>{
          const el = document.getElementById(id);
          if (el) el.addEventListener("change", ()=>{ /* draw loop picks up states via safeChecked */ });
        });

        // initial layout
        setTimeout(()=>{ setCellSize(); fitTableToScreen(); updateLanguage(); adjustToolbarAfterLayout(); }, 80);
      });

      function positionNotePopup(){
        const n = document.getElementById("note-popup");
        const tb = document.getElementById("toolbar").getBoundingClientRect();
        n.style.left = Math.max(8, tb.left + tb.width/2 - n.offsetWidth/2) + "px";
        n.style.top = (tb.bottom + 8) + "px";
        n.style.transform = `scale(${Math.min(1,zoom)})`;
      }

      function updateLanguage(){
        const sel = document.getElementById("languageSelect").value || "vi";
        currentLang = translations[sel] ? sel : "vi";
        const dict = translations[currentLang] || translations.vi;
        document.getElementById("label_showMetal").textContent = dict.showMetal || "Kim loại";
        document.getElementById("label_showNonMetal").textContent = dict.showNonMetal || "Phi kim";
        document.getElementById("label_showNobleGas").textContent = dict.showNobleGas || "Khí trơ (khí hiếm)";
        document.getElementById("label_showMetalloid").textContent = dict.showMetalloid || "Á kim";
        document.getElementById("label_showS").textContent = "s";
        document.getElementById("label_showP").textContent = "p";
        document.getElementById("label_showD").textContent = "d";
        document.getElementById("label_showF").textContent = "f";
        document.getElementById("label_showConfig").textContent = dict.showConfig || "Cấu hình e";
        document.getElementById("label_guide").textContent = dict.guide || "Hướng dẫn";
        document.getElementById("noteTitle").textContent = dict.noteTitle || "Hướng dẫn";
        document.getElementById("noteList").innerHTML = (dict.noteList || []).join("");

        const startPx = LANG_INITIAL_FONT_PX[sel] || 14;
        setToolbarFontSize(startPx);
        adjustToolbarForLanguage(startPx);

        const n = document.getElementById("note-popup");
        if (n.style.display === "block") positionNotePopup();
      }

      function closeNotePopup(e){ e.stopPropagation(); document.getElementById("note-popup").style.display = "none"; }

      /* ---------------------
         Responsive toolbar
      --------------------- */
      function adjustToolbarForLanguage(startPx) {
        const toolbar = document.getElementById('toolbar');
        if (!toolbar) return;

        toolbar.classList.remove('wrapable');
        toolbar.style.flexWrap = 'nowrap';
        toolbar.style.overflowX = 'hidden';
        setToolbarPadding(6, 10, 10);

        let px = Math.min(22, Math.max(MIN_FONT_PX, startPx || 14));
        setToolbarFontSize(px);

        requestAnimationFrame(() => {
          const availableWidth = Math.max(200, window.innerWidth - H_MARGIN);

          if (toolbar.scrollWidth <= availableWidth) {
            toolbar.style.overflowX = 'hidden';
            return;
          }

          const scale = availableWidth / toolbar.scrollWidth;
          let newPx = Math.floor(px * scale);
          newPx = Math.max(MIN_FONT_PX, Math.min(px, newPx));
          setToolbarFontSize(newPx);

          requestAnimationFrame(() => {
            if (toolbar.scrollWidth <= availableWidth) { toolbar.style.overflowX = 'hidden'; return; }

            let cur = newPx;
            while (cur > MIN_FONT_PX && toolbar.scrollWidth > availableWidth) {
              cur -= 1;
              setToolbarFontSize(cur);
            }
            if (toolbar.scrollWidth <= availableWidth) { toolbar.style.overflowX = 'hidden'; return; }

            const padSteps = [
              {padV:5, padH:8, gap:8},
              {padV:4, padH:6, gap:6}
            ];
            for (let s of padSteps) {
              setToolbarPadding(s.padV, s.padH, s.gap);
            }

            requestAnimationFrame(() => {
              if (toolbar.scrollWidth <= availableWidth) { toolbar.style.overflowX = 'hidden'; return; }
              toolbar.classList.add('wrapable');
              toolbar.style.flexWrap = 'wrap';
              toolbar.style.overflowX = 'visible';
              setToolbarFontSize(Math.max(MIN_FONT_PX, Math.floor(MIN_FONT_PX + (startPx - MIN_FONT_PX) * 0.6)));
            });
          });
        });
      }

      function adjustToolbarAfterLayout(){ const sel = document.getElementById("languageSelect").value || "vi"; adjustToolbarForLanguage(LANG_INITIAL_FONT_PX[sel] || 14); }
      window.addEventListener("resize", () => adjustToolbarAfterLayout(), { passive: true });

      // keyboard reset
      document.addEventListener("keydown", (e)=>{
        if (e.key === "r" || e.key === "R"){
          fitTableToScreen();
          selected = null; manualToggle = false; highlightedRow = null; highlightedColGroup = null;
          const popup = document.getElementById("element-popup");
          if (popup) popup.style.display = "none";
        }
      });

      // draggable helper
      const clampVal = (v,min,max) => Math.max(min, Math.min(max, v));
      const makeDraggable = (elem, options = {})=>{
        if(!elem) return;
        let active=false, offX=0, offY=0;
        elem.addEventListener("mousedown",(e)=>{
          if(e.button !== 0) return;
          if(options.check && !options.check(e)) return;
          active=true; elem.classList.add("dragging");
          const r = elem.getBoundingClientRect();
          offX = e.clientX - r.left; offY = e.clientY - r.top;
          e.preventDefault(); e.stopPropagation();
        });
        document.addEventListener("mousemove",(e)=>{ if(!active) return; const nx = clampVal(e.clientX-offX,8,window.innerWidth-elem.offsetWidth-8); const ny = clampVal(e.clientY-offY,8,window.innerHeight-elem.offsetHeight-8); elem.style.left = nx + "px"; elem.style.top = ny + "px"; });
        document.addEventListener("mouseup",()=>{ if(active){ active=false; elem.classList.remove("dragging"); }});
      };
    </script>
  </body>
</html>